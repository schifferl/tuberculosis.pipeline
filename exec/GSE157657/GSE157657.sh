#!/bin/bash -l

#$ -e /dev/null
#$ -o /dev/null
#$ -P tuberculosis
#$ -pe omp 16
#$ -t 1-760

module load sratoolkit/2.10.5
module load nextflow/19.10.0

INDEX=$(($SGE_TASK_ID-1))

INPUT=(SRR12609770 SRR12609771 SRR12609772 SRR12609773 SRR12609774 SRR12609775 SRR12609776 SRR12609777 SRR12609778 SRR12609779 SRR12609780 SRR12609781 SRR12609782 SRR12609783 SRR12609784 SRR12609785 SRR12609786 SRR12609787 SRR12609788 SRR12609789 SRR12609790 SRR12609791 SRR12609792 SRR12609793 SRR12609794 SRR12609795 SRR12609796 SRR12609797 SRR12609798 SRR12609799 SRR12609800 SRR12609801 SRR12609802 SRR12609803 SRR12609804 SRR12609805 SRR12609806 SRR12609807 SRR12609808 SRR12609809 SRR12609810 SRR12609811 SRR12609812 SRR12609813 SRR12609814 SRR12609815 SRR12609816 SRR12609817 SRR12609818 SRR12609819 SRR12609820 SRR12609821 SRR12609822 SRR12609823 SRR12609824 SRR12609825 SRR12609826 SRR12609827 SRR12609828 SRR12609829 SRR12609830 SRR12609831 SRR12609832 SRR12609833 SRR12609834 SRR12609835 SRR12609836 SRR12609837 SRR12609838 SRR12609839 SRR12609840 SRR12609841 SRR12609842 SRR12609843 SRR12609844 SRR12609845 SRR12609846 SRR12609847 SRR12609848 SRR12609849 SRR12609850 SRR12609851 SRR12609852 SRR12609853 SRR12609854 SRR12609855 SRR12609856 SRR12609857 SRR12609858 SRR12609859 SRR12609860 SRR12609861 SRR12609862 SRR12609863 SRR12609864 SRR12609865 SRR12609394 SRR12609395 SRR12609396 SRR12609397 SRR12609398 SRR12609399 SRR12609400 SRR12609401 SRR12609402 SRR12609403 SRR12609404 SRR12609405 SRR12609406 SRR12609407 SRR12609408 SRR12609409 SRR12609410 SRR12609411 SRR12609412 SRR12609413 SRR12609414 SRR12609415 SRR12609416 SRR12609417 SRR12609418 SRR12609419 SRR12609420 SRR12609421 SRR12609422 SRR12609423 SRR12609424 SRR12609425 SRR12609426 SRR12609427 SRR12609428 SRR12609429 SRR12609430 SRR12609431 SRR12609432 SRR12609433 SRR12609434 SRR12609435 SRR12609436 SRR12609437 SRR12609438 SRR12609439 SRR12609440 SRR12609441 SRR12609442 SRR12609443 SRR12609444 SRR12609445 SRR12609446 SRR12609447 SRR12609448 SRR12609449 SRR12609450 SRR12609451 SRR12609452 SRR12609453 SRR12609454 SRR12609455 SRR12609456 SRR12609457 SRR12609458 SRR12609459 SRR12609460 SRR12609461 SRR12609462 SRR12609463 SRR12609464 SRR12609465 SRR12609466 SRR12609467 SRR12609468 SRR12609469 SRR12609470 SRR12609471 SRR12609472 SRR12609473 SRR12609474 SRR12609475 SRR12609476 SRR12609477 SRR12609478 SRR12609479 SRR12609480 SRR12609481 SRR12609482 SRR12609483 SRR12609484 SRR12609485 SRR12609486 SRR12609487 SRR12609488 SRR12609489 SRR12609866 SRR12609867 SRR12609868 SRR12609869 SRR12609870 SRR12609871 SRR12609872 SRR12609873 SRR12609874 SRR12609875 SRR12609876 SRR12609877 SRR12609878 SRR12609879 SRR12609880 SRR12609881 SRR12609882 SRR12609883 SRR12609884 SRR12609885 SRR12609886 SRR12609887 SRR12609888 SRR12609889 SRR12609890 SRR12609891 SRR12609892 SRR12609893 SRR12609894 SRR12609895 SRR12609896 SRR12609897 SRR12609898 SRR12609899 SRR12609900 SRR12609901 SRR12609902 SRR12609903 SRR12609904 SRR12609905 SRR12609906 SRR12609907 SRR12609908 SRR12609909 SRR12609910 SRR12609911 SRR12609912 SRR12609913 SRR12609914 SRR12609915 SRR12609916 SRR12609917 SRR12609918 SRR12609919 SRR12609920 SRR12609921 SRR12609922 SRR12609923 SRR12609924 SRR12609925 SRR12609926 SRR12609927 SRR12609928 SRR12609929 SRR12609930 SRR12609931 SRR12609932 SRR12609933 SRR12609934 SRR12609935 SRR12609936 SRR12609937 SRR12609938 SRR12609939 SRR12609940 SRR12609941 SRR12609942 SRR12609943 SRR12609944 SRR12609945 SRR12609946 SRR12609947 SRR12609948 SRR12609949 SRR12609950 SRR12609951 SRR12609952 SRR12609953 SRR12609954 SRR12609955 SRR12609956 SRR12609957 SRR12609958 SRR12609959 SRR12609960 SRR12609961 SRR12609490 SRR12609491 SRR12609492 SRR12609493 SRR12609494 SRR12609495 SRR12609496 SRR12609497 SRR12609498 SRR12609499 SRR12609500 SRR12609501 SRR12609502 SRR12609503 SRR12609504 SRR12609505 SRR12609506 SRR12609507 SRR12609508 SRR12609509 SRR12609510 SRR12609511 SRR12609512 SRR12609513 SRR12609514 SRR12609515 SRR12609516 SRR12609517 SRR12609518 SRR12609519 SRR12609520 SRR12609521 SRR12609522 SRR12609523 SRR12609524 SRR12609525 SRR12609526 SRR12609527 SRR12609528 SRR12609529 SRR12609530 SRR12609531 SRR12609532 SRR12609533 SRR12609534 SRR12609535 SRR12609536 SRR12609537 SRR12609538 SRR12609539 SRR12609540 SRR12609541 SRR12609542 SRR12609543 SRR12609544 SRR12609545 SRR12609546 SRR12609547 SRR12609548 SRR12609549 SRR12609550 SRR12609551 SRR12609552 SRR12609553 SRR12609554 SRR12609555 SRR12609556 SRR12609557 SRR12609558 SRR12609559 SRR12609560 SRR12609561 SRR12609562 SRR12609563 SRR12609564 SRR12609565 SRR12609566 SRR12609567 SRR12609568 SRR12609569 SRR12609570 SRR12609571 SRR12609572 SRR12609573 SRR12609574 SRR12609575 SRR12609576 SRR12609577 SRR12609578 SRR12609579 SRR12609580 SRR12609581 SRR12609582 SRR12609583 SRR12609584 SRR12609585 SRR12609962 SRR12609963 SRR12609964 SRR12609965 SRR12609966 SRR12609967 SRR12609968 SRR12609969 SRR12609970 SRR12609971 SRR12609972 SRR12609973 SRR12609974 SRR12609975 SRR12609976 SRR12609977 SRR12609978 SRR12609979 SRR12609980 SRR12609981 SRR12609982 SRR12609983 SRR12609984 SRR12609985 SRR12609986 SRR12609987 SRR12609988 SRR12609989 SRR12609990 SRR12609991 SRR12609992 SRR12609993 SRR12609994 SRR12609995 SRR12609996 SRR12609997 SRR12609998 SRR12609999 SRR12610000 SRR12610001 SRR12610002 SRR12610003 SRR12610004 SRR12610005 SRR12610006 SRR12610007 SRR12610008 SRR12610009 SRR12610010 SRR12610011 SRR12610012 SRR12610013 SRR12610014 SRR12610015 SRR12610016 SRR12610017 SRR12610018 SRR12610019 SRR12610020 SRR12610021 SRR12610022 SRR12610023 SRR12610024 SRR12610025 SRR12610026 SRR12610027 SRR12610028 SRR12610029 SRR12610030 SRR12610031 SRR12610032 SRR12610033 SRR12610034 SRR12610035 SRR12610036 SRR12610037 SRR12610038 SRR12610039 SRR12610040 SRR12610041 SRR12610042 SRR12610043 SRR12610044 SRR12610045 SRR12610046 SRR12610047 SRR12610048 SRR12610049 SRR12610050 SRR12610051 SRR12610052 SRR12610053 SRR12610054 SRR12610055 SRR12610056 SRR12610057 SRR12609586 SRR12609587 SRR12609588 SRR12609589 SRR12609590 SRR12609591 SRR12609592 SRR12609593 SRR12609594 SRR12609595 SRR12609596 SRR12609597 SRR12609598 SRR12609599 SRR12609600 SRR12609601 SRR12609602 SRR12609603 SRR12609604 SRR12609605 SRR12609606 SRR12609607 SRR12609608 SRR12609609 SRR12609610 SRR12609611 SRR12609612 SRR12609613 SRR12609614 SRR12609615 SRR12609616 SRR12609617 SRR12609618 SRR12609619 SRR12609620 SRR12609621 SRR12609622 SRR12609623 SRR12609624 SRR12609625 SRR12609626 SRR12609627 SRR12609628 SRR12609629 SRR12609630 SRR12609631 SRR12609632 SRR12609633 SRR12609634 SRR12609635 SRR12609636 SRR12609637 SRR12609638 SRR12609639 SRR12609640 SRR12609641 SRR12609642 SRR12609643 SRR12609644 SRR12609645 SRR12609646 SRR12609647 SRR12609648 SRR12609649 SRR12609650 SRR12609651 SRR12609652 SRR12609653 SRR12609654 SRR12609655 SRR12609656 SRR12609657 SRR12609658 SRR12609659 SRR12609660 SRR12609661 SRR12609662 SRR12609663 SRR12609664 SRR12609665 SRR12609666 SRR12609667 SRR12609668 SRR12609669 SRR12609670 SRR12609671 SRR12609672 SRR12609673 SRR12609674 SRR12609675 SRR12609676 SRR12609677 SRR12609678 SRR12609679 SRR12609680 SRR12609681 SRR12610058 SRR12610059 SRR12610060 SRR12610061 SRR12610062 SRR12610063 SRR12610064 SRR12610065 SRR12610066 SRR12610067 SRR12610068 SRR12610069 SRR12610070 SRR12610071 SRR12610072 SRR12610073 SRR12610074 SRR12610075 SRR12610076 SRR12610077 SRR12610078 SRR12610079 SRR12610080 SRR12610081 SRR12610082 SRR12610083 SRR12610084 SRR12610085 SRR12610086 SRR12610087 SRR12610088 SRR12610089 SRR12610090 SRR12610091 SRR12610092 SRR12610093 SRR12610094 SRR12610095 SRR12610096 SRR12610097 SRR12610098 SRR12610099 SRR12610100 SRR12610101 SRR12610102 SRR12610103 SRR12610104 SRR12610105 SRR12610106 SRR12610107 SRR12610108 SRR12610109 SRR12610110 SRR12610111 SRR12610112 SRR12610113 SRR12610114 SRR12610115 SRR12610116 SRR12610117 SRR12610118 SRR12610119 SRR12610120 SRR12610121 SRR12610122 SRR12610123 SRR12610124 SRR12610125 SRR12610126 SRR12610127 SRR12610128 SRR12610129 SRR12610130 SRR12610131 SRR12610132 SRR12610133 SRR12610134 SRR12610135 SRR12610136 SRR12610137 SRR12610138 SRR12610139 SRR12610140 SRR12610141 SRR12610142 SRR12610143 SRR12610144 SRR12610145 SRR12610146 SRR12610147 SRR12610148 SRR12610149 SRR12610150 SRR12610151 SRR12610152 SRR12610153 SRR12609682 SRR12609683 SRR12609684 SRR12609685 SRR12609686 SRR12609687 SRR12609688 SRR12609689 SRR12609690 SRR12609691 SRR12609692 SRR12609693 SRR12609694 SRR12609695 SRR12609696 SRR12609697 SRR12609698 SRR12609699 SRR12609700 SRR12609701 SRR12609702 SRR12609703 SRR12609704 SRR12609705 SRR12609706 SRR12609707 SRR12609708 SRR12609709 SRR12609710 SRR12609711 SRR12609712 SRR12609713 SRR12609714 SRR12609715 SRR12609716 SRR12609717 SRR12609718 SRR12609719 SRR12609720 SRR12609721 SRR12609722 SRR12609723 SRR12609724 SRR12609725 SRR12609726 SRR12609727 SRR12609728 SRR12609729 SRR12609730 SRR12609731 SRR12609732 SRR12609733 SRR12609734 SRR12609735 SRR12609736 SRR12609737 SRR12609738 SRR12609739 SRR12609740 SRR12609741 SRR12609742 SRR12609743 SRR12609744 SRR12609745 SRR12609746 SRR12609747 SRR12609748 SRR12609749 SRR12609750 SRR12609751 SRR12609752 SRR12609753 SRR12609754 SRR12609755 SRR12609756 SRR12609757 SRR12609758 SRR12609759 SRR12609760 SRR12609761 SRR12609762 SRR12609763 SRR12609764 SRR12609765 SRR12609766 SRR12609767 SRR12609768 SRR12609769)
SRRID=${INPUT[$INDEX]}

SERIES_LIBRARY_LAYOUT=(PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED)
SAMPLE_LIBRARY_LAYOUT=${SERIES_LIBRARY_LAYOUT[$INDEX]}

if [[ -e "$SRRID.tsv.gz" ]]; then
  exit
fi

prefetch --output-directory "/scratch/$USER" $SRRID | grep "\S" &> "$SRRID.log"

if [[ -d $SRRID ]]; then
  mv $SRRID/* "/scratch/$USER/$SRRID" && rm -rf $SRRID
fi

(cd "/scratch/$USER" && fasterq-dump --outdir $SRRID --temp $SRRID --threads 16 $SRRID) &>> "$SRRID.log"

if [[ $SAMPLE_LIBRARY_LAYOUT == "PAIRED" ]]; then
  nextflow run -profile singularity -revision 1.4.2 -work-dir "/scratch/$USER/$SRRID/work" nf-core/rnaseq --reads "/scratch/$USER/$SRRID/*{1,2}.fastq" --genome GRCh38 --skipBiotypeQC --outdir "/scratch/$USER/$SRRID/results" &>> "$SRRID.log"
fi

if [[ $SAMPLE_LIBRARY_LAYOUT == "SINGLE" ]]; then
  nextflow run -profile singularity -revision 1.4.2 -work-dir "/scratch/$USER/$SRRID/work" nf-core/rnaseq --reads "/scratch/$USER/$SRRID/*.fastq" --singleEnd --genome GRCh38 --skipBiotypeQC --outdir "/scratch/$USER/$SRRID/results" &>> "$SRRID.log"
fi

if [[ -n $(grep -l "Succeeded   : 13" "$SRRID.log") ]]; then
  gzip --stdout "/scratch/$USER/$SRRID/results/featureCounts/merged_gene_counts.txt" > "$SRRID.tsv.gz"
fi

rm -rf "/scratch/$USER/$SRRID"

