#!/bin/bash -l

#$ -e /dev/null
#$ -o /dev/null
#$ -P tuberculosis
#$ -pe omp 16
#$ -t 1-355

module load sratoolkit/2.10.5
module load nextflow/19.10.0

INDEX=$(($SGE_TASK_ID-1))

INPUT=(SRR3235783 SRR3235784 SRR3235785 SRR3235786 SRR3235787 SRR3235788 SRR3235789 SRR3235790 SRR3235791 SRR3235792 SRR3235793 SRR3235794 SRR3235795 SRR3235796 SRR3235797 SRR3235798 SRR3235799 SRR3235800 SRR3235801 SRR3235802 SRR3235803 SRR3235804 SRR3235805 SRR3235806 SRR3235807 SRR3235808 SRR3235809 SRR3235810 SRR3235811 SRR3235812 SRR3235813 SRR3235814 SRR3235815 SRR3235816 SRR3235817 SRR3235818 SRR3235819 SRR3235820 SRR3235821 SRR3235822 SRR3235823 SRR3235824 SRR3235825 SRR3235826 SRR3235827 SRR3235828 SRR3235829 SRR3235830 SRR3235831 SRR3235832 SRR3235833 SRR3235834 SRR3235835 SRR3235836 SRR3235837 SRR3235838 SRR3235839 SRR3235840 SRR3235841 SRR3235842 SRR3235843 SRR3235844 SRR3235845 SRR3235846 SRR3235847 SRR3235848 SRR3235849 SRR3235850 SRR3235851 SRR3235852 SRR3235853 SRR3235854 SRR3235855 SRR3235856 SRR3235857 SRR3235858 SRR3235859 SRR3235860 SRR3235861 SRR3235862 SRR3235863 SRR3235864 SRR3235865 SRR3235866 SRR3235867 SRR3235868 SRR3235869 SRR3235870 SRR3235871 SRR3235872 SRR3235873 SRR3235874 SRR3235875 SRR3235876 SRR3235877 SRR3235878 SRR3235879 SRR3235880 SRR3235881 SRR3235882 SRR3235883 SRR3235884 SRR3235885 SRR3235886 SRR3235887 SRR3235888 SRR3235889 SRR3235890 SRR3235891 SRR3235892 SRR3235893 SRR3235894 SRR3235895 SRR3235896 SRR3235897 SRR3235898 SRR3235899 SRR3235900 SRR3235901 SRR3235902 SRR3235903 SRR3235904 SRR3235905 SRR3235906 SRR3235907 SRR3235908 SRR3235909 SRR3235910 SRR3235911 SRR3235912 SRR3235913 SRR3235914 SRR3235915 SRR3235916 SRR3235917 SRR3235918 SRR3235919 SRR3235920 SRR3235921 SRR3235922 SRR3235923 SRR3235924 SRR3235925 SRR3235926 SRR3235927 SRR3235928 SRR3235929 SRR3235930 SRR3235931 SRR3235932 SRR3235933 SRR3235934 SRR3235935 SRR3235936 SRR3235937 SRR3235938 SRR3235939 SRR3235940 SRR3235941 SRR3235942 SRR3235943 SRR3235944 SRR3235945 SRR3235946 SRR3235947 SRR3235948 SRR3235949 SRR3235950 SRR3235951 SRR3235952 SRR3235953 SRR3235954 SRR3235955 SRR3235956 SRR3235957 SRR3235958 SRR3235959 SRR3235960 SRR3235961 SRR3235962 SRR3235963 SRR3235964 SRR3235965 SRR3235966 SRR3235967 SRR3235968 SRR3235969 SRR3235970 SRR3235971 SRR3235972 SRR3235973 SRR3235974 SRR3235975 SRR3235976 SRR3235977 SRR3235978 SRR3235979 SRR3235980 SRR3235981 SRR3235982 SRR3235983 SRR3235984 SRR3235985 SRR3235986 SRR3235987 SRR3235988 SRR3235989 SRR3235990 SRR3235991 SRR3235992 SRR3235993 SRR3235994 SRR3235995 SRR3235996 SRR3235997 SRR3235998 SRR3235999 SRR3236000 SRR3236001 SRR3236002 SRR3236003 SRR3236004 SRR3236005 SRR3236006 SRR3236007 SRR3236008 SRR3236009 SRR3236010 SRR3236011 SRR3236012 SRR3236013 SRR3236014 SRR3236015 SRR3236016 SRR3236017 SRR3236018 SRR3236019 SRR3236020 SRR3236021 SRR3236022 SRR3236023 SRR3236024 SRR3236025 SRR3236026 SRR3236027 SRR3236028 SRR3236029 SRR3236030 SRR3236031 SRR3236032 SRR3236033 SRR3236034 SRR3236035 SRR3236036 SRR3236037 SRR3236038 SRR3236039 SRR3236040 SRR3236041 SRR3236042 SRR3236043 SRR3236044 SRR3236045 SRR3236046 SRR3236047 SRR3235782 SRR3236048 SRR3236049 SRR3236050 SRR3236051 SRR3236052 SRR3236053 SRR3236054 SRR3236055 SRR3236056 SRR3236057 SRR3236058 SRR3236059 SRR3236060 SRR3236061 SRR3236062 SRR3236063 SRR3236064 SRR3236065 SRR3236066 SRR3236067 SRR3236068 SRR3236069 SRR3236070 SRR3236071 SRR3236072 SRR3236073 SRR3236074 SRR3236075 SRR3236076 SRR3236077 SRR3236078 SRR3236079 SRR3236080 SRR3236081 SRR3236082 SRR3236083 SRR3236084 SRR3236085 SRR3236086 SRR3236087 SRR3236088 SRR3236089 SRR3236090 SRR3236091 SRR3236092 SRR3236093 SRR3236094 SRR3236095 SRR3236096 SRR3236097 SRR3236098 SRR3236099 SRR3236100 SRR3236101 SRR3236102 SRR3236103 SRR3236104 SRR3236105 SRR3236106 SRR3236107 SRR3236108 SRR3236109 SRR3236110 SRR3236111 SRR3236112 SRR3236113 SRR3236114 SRR3236115 SRR3236116 SRR3236117 SRR3236118 SRR3236119 SRR3236120 SRR3236121 SRR3236122 SRR3236123 SRR3236124 SRR3236125 SRR3236126 SRR3236127 SRR3236128 SRR3236129 SRR3236130 SRR3236131 SRR3236132 SRR3236133 SRR3236134 SRR3236135 SRR5151120)
SRRID=${INPUT[$INDEX]}

SERIES_LIBRARY_LAYOUT=(PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED)
SAMPLE_LIBRARY_LAYOUT=${SERIES_LIBRARY_LAYOUT[$INDEX]}

if [[ -e "$SRRID.tsv.gz" ]]; then
  exit
fi

prefetch --output-directory "/scratch/$USER" $SRRID | grep "\S" &> "$SRRID.log"
fasterq-dump --outdir "/scratch/$USER/$SRRID" --temp "/scratch/$USER/$SRRID" --threads 16 "/scratch/$USER/$SRRID" &>> "$SRRID.log"

if [[ $SAMPLE_LIBRARY_LAYOUT == "PAIRED" ]]; then
  nextflow run -profile singularity -revision 1.4.2 -work-dir "/scratch/$USER/$SRRID/work" nf-core/rnaseq --reads "/scratch/$USER/$SRRID/*{1,2}.fastq" --genome GRCh38 --skipBiotypeQC --outdir "/scratch/$USER/$SRRID/results" &>> "$SRRID.log"
fi

if [[ $SAMPLE_LIBRARY_LAYOUT == "SINGLE" ]]; then
  nextflow run -profile singularity -revision 1.4.2 -work-dir "/scratch/$USER/$SRRID/work" nf-core/rnaseq --reads "/scratch/$USER/$SRRID/*.fastq" --singleEnd --genome GRCh38 --skipBiotypeQC --outdir "/scratch/$USER/$SRRID/results" &>> "$SRRID.log"
fi

if [[ -n $(grep -l "Succeeded   : 13" "$SRRID.log") ]]; then
  gzip --stdout "/scratch/$USER/$SRRID/results/featureCounts/merged_gene_counts.txt" > "$SRRID.tsv.gz"
fi

rm -rf "/scratch/$USER/$SRRID"

