#!/bin/bash -l

#$ -e /dev/null
#$ -o /dev/null
#$ -P tuberculosis
#$ -pe omp 16
#$ -t 1-414

module load sratoolkit/2.10.5
module load nextflow/19.10.0

INDEX=$(($SGE_TASK_ID-1))

INPUT=(SRR6369879 SRR6369880 SRR6369881 SRR6369882 SRR6369883 SRR6369884 SRR6369885 SRR6369886 SRR6369887 SRR6369888 SRR6369889 SRR6369890 SRR6369891 SRR6369892 SRR6369893 SRR6369894 SRR6369895 SRR6369896 SRR6369897 SRR6369898 SRR6369899 SRR6369900 SRR6369901 SRR6369902 SRR6369903 SRR6369904 SRR6369905 SRR6369906 SRR6369907 SRR6369908 SRR6369909 SRR6369910 SRR6369911 SRR6369912 SRR6369913 SRR6369914 SRR6369915 SRR6369916 SRR6369917 SRR6369918 SRR6369919 SRR6369920 SRR6369921 SRR6369922 SRR6369923 SRR6369924 SRR6369925 SRR6369926 SRR6369927 SRR6369928 SRR6369929 SRR6369930 SRR6369931 SRR6369932 SRR6369945 SRR6369946 SRR6369947 SRR6369948 SRR6369949 SRR6369950 SRR6369951 SRR6369952 SRR6369953 SRR6369954 SRR6369955 SRR6369956 SRR6369957 SRR6369958 SRR6369959 SRR6369960 SRR6369961 SRR6369962 SRR6369963 SRR6369964 SRR6369965 SRR6369966 SRR6369967 SRR6369968 SRR6369969 SRR6369970 SRR6369971 SRR6369972 SRR6369973 SRR6369974 SRR6369975 SRR6369976 SRR6369977 SRR6369978 SRR6369979 SRR6369980 SRR6369981 SRR6369982 SRR6369983 SRR6369984 SRR6369985 SRR6369986 SRR6369987 SRR6369988 SRR6369989 SRR6369990 SRR6369991 SRR6370167 SRR6370168 SRR6370169 SRR6370170 SRR6370171 SRR6370172 SRR6370173 SRR6370174 SRR6370175 SRR6370176 SRR6370177 SRR6370178 SRR6370179 SRR6370180 SRR6370181 SRR6370182 SRR6370183 SRR6370184 SRR6370185 SRR6370186 SRR6370187 SRR6370188 SRR6370189 SRR6370190 SRR6370191 SRR6370192 SRR6370193 SRR6370194 SRR6370195 SRR6370196 SRR6370197 SRR6370198 SRR6370199 SRR6370200 SRR6370201 SRR6370202 SRR6370203 SRR6370204 SRR6370205 SRR6370206 SRR6370207 SRR6370208 SRR6370209 SRR6370210 SRR6370211 SRR6370212 SRR6370213 SRR6370214 SRR6370215 SRR6370216 SRR6370217 SRR6370218 SRR6370219 SRR6370220 SRR6370221 SRR6370222 SRR6370223 SRR6370224 SRR6370225 SRR6370226 SRR6370227 SRR6370228 SRR6370229 SRR6370230 SRR6370231 SRR6370232 SRR6370233 SRR6370234 SRR6370235 SRR6370236 SRR6370237 SRR6370238 SRR6370239 SRR6370240 SRR6370241 SRR6370242 SRR6370243 SRR6370244 SRR6370245 SRR6370246 SRR6370247 SRR6370248 SRR6370249 SRR6370250 SRR6370251 SRR6370252 SRR6370253 SRR6370254 SRR6370255 SRR6370256 SRR6370257 SRR6370258 SRR6370259 SRR6370260 SRR6370261 SRR6370262 SRR6370263 SRR6370264 SRR6370265 SRR6370266 SRR6370267 SRR6370268 SRR6370269 SRR6370270 SRR6370271 SRR6370272 SRR6370273 SRR6370274 SRR6370275 SRR6370276 SRR6370277 SRR6370278 SRR6370279 SRR6370280 SRR6370281 SRR6370282 SRR6370283 SRR6370284 SRR6370285 SRR6370286 SRR6370287 SRR6370288 SRR6370289 SRR6370290 SRR6370291 SRR6370292 SRR6370293 SRR6370294 SRR6370295 SRR6370296 SRR6370297 SRR6370298 SRR6370299 SRR6370300 SRR6370301 SRR6370302 SRR6370303 SRR6370304 SRR6369992 SRR6369993 SRR6369994 SRR6369995 SRR6369996 SRR6369997 SRR6369998 SRR6369999 SRR6370000 SRR6370001 SRR6370002 SRR6370003 SRR6370004 SRR6370005 SRR6370006 SRR6370007 SRR6370008 SRR6370009 SRR6370010 SRR6370011 SRR6370012 SRR6370013 SRR6370014 SRR6370015 SRR6370016 SRR6370017 SRR6370018 SRR6370019 SRR6370020 SRR6370021 SRR6370022 SRR6370023 SRR6370024 SRR6370025 SRR6370026 SRR6370027 SRR6370028 SRR6370029 SRR6370030 SRR6370031 SRR6370032 SRR6370033 SRR6370034 SRR6370035 SRR6370036 SRR6370037 SRR6370038 SRR6370039 SRR6370040 SRR6370041 SRR6370042 SRR6370043 SRR6370044 SRR6370045 SRR6370046 SRR6370047 SRR6370048 SRR6370049 SRR6370050 SRR6370051 SRR6370052 SRR6370053 SRR6370054 SRR6370055 SRR6370056 SRR6370057 SRR6370058 SRR6370059 SRR6370060 SRR6370061 SRR6370062 SRR6370063 SRR6370064 SRR6370065 SRR6370066 SRR6370067 SRR6370068 SRR6370069 SRR6370070 SRR6370071 SRR6370072 SRR6370073 SRR6370074 SRR6370075 SRR6370076 SRR6370077 SRR6370078 SRR6370079 SRR6370080 SRR6370081 SRR6370082 SRR6370083 SRR6370084 SRR6370085 SRR6370086 SRR6370087 SRR6370088 SRR6370089 SRR6370090 SRR6370091 SRR6370092 SRR6370093 SRR6370094 SRR6370095 SRR6370096 SRR6370097 SRR6370098 SRR6370099 SRR6370100 SRR6370101 SRR6370102 SRR6370103 SRR6370104 SRR6370105 SRR6370106 SRR6370107 SRR6370108 SRR6370109 SRR6370110 SRR6370111 SRR6370112 SRR6370113 SRR6370114 SRR6370115 SRR6370116 SRR6370117 SRR6370118 SRR6370119 SRR6370120 SRR6370121 SRR6370122 SRR6370123 SRR6370124 SRR6370125 SRR6370126 SRR6370127 SRR6370128 SRR6370129 SRR6370130 SRR6370131 SRR6370132 SRR6370133 SRR6370134 SRR6370135 SRR6370136 SRR6370137 SRR6370138 SRR6370139 SRR6370140 SRR6370141 SRR6370142 SRR6370143 SRR6370144 SRR6370145 SRR6370146 SRR6370147 SRR6370148 SRR6370149 SRR6370150 SRR6370151 SRR6370152 SRR6370153 SRR6370154 SRR6370155 SRR6370156 SRR6370157 SRR6370158 SRR6370159 SRR6370160 SRR6370161 SRR6370162 SRR6370163 SRR6370164 SRR6370165 SRR6370166)
SRRID=${INPUT[$INDEX]}

SERIES_LIBRARY_LAYOUT=(PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED PAIRED)
SAMPLE_LIBRARY_LAYOUT=${SERIES_LIBRARY_LAYOUT[$INDEX]}

if [[ -e "$SRRID.tsv.gz" ]]; then
  exit
fi

prefetch --output-directory "/scratch/$USER" $SRRID | grep "\S" &> "$SRRID.log"
fasterq-dump --outdir "/scratch/$USER/$SRRID" --temp "/scratch/$USER/$SRRID" --threads 16 "/scratch/$USER/$SRRID" &>> "$SRRID.log"

if [[ $SAMPLE_LIBRARY_LAYOUT == "PAIRED" ]]; then
  nextflow run -profile singularity -revision 1.4.2 -work-dir "/scratch/$USER/$SRRID/work" nf-core/rnaseq --reads "/scratch/$USER/$SRRID/*{1,2}.fastq" --genome GRCh38 --skipBiotypeQC --outdir "/scratch/$USER/$SRRID/results" &>> "$SRRID.log"
fi

if [[ $SAMPLE_LIBRARY_LAYOUT == "SINGLE" ]]; then
  nextflow run -profile singularity -revision 1.4.2 -work-dir "/scratch/$USER/$SRRID/work" nf-core/rnaseq --reads "/scratch/$USER/$SRRID/*.fastq" --singleEnd --genome GRCh38 --skipBiotypeQC --outdir "/scratch/$USER/$SRRID/results" &>> "$SRRID.log"
fi

if [[ -n $(grep -l "Succeeded   : 13" "$SRRID.log") ]]; then
  gzip --stdout "/scratch/$USER/$SRRID/results/featureCounts/merged_gene_counts.txt" > "$SRRID.tsv.gz"
fi

rm -rf "/scratch/$USER/$SRRID"

